############################
#
# Crisis Events III
# Replaced by A Deadly Tempest (Cybrex awakening)
#
############################

namespace = crisis

# Spawn Cybrex
country_event = {
	id = crisis.2400
	hide_window = yes

	trigger = {
		NOT = { has_global_flag = cybrex_resurface }
		OR = {
			AND = {
				has_global_flag = ai_invasion_ongoing
				is_country_type = ai_empire
				galaxy_percentage > 0.20
			}
			AND = {
				has_global_flag = gray_goo_crisis_active
				is_country_type = gray_goo
				num_fleets > 60 # TODO dynamically!?
			}
		}
	}

	mean_time_to_happen = {
		months = 12
	}

	immediate = {
		set_global_flag = cybrex_resurface
		remove_global_flag = cybrex_departed
		remove_global_flag = cybrex_destroyed
		random_rim_system = {
			limit = { NOT = { has_star_flag = sealed_system } }
			spawn_system = {
				min_distance >= 15
				max_distance <= 40
				initializer = "cybrex_beta"
			}
		}
		# Vanilla doesnt use/check his own saved targets!?
		if = { limit = { NOT = { exists = event_target:cybrex } }
			random_country = {
				limit = { is_country_type = cybrex_empire }
				save_global_event_target_as = cybrex
			}
		}

		save_event_target_as = cybrex_target

		observer_event = { id = observer.52 }
		every_country = {
			limit = { is_country_type = default }
			country_event = { id = crisis.2401 days = 2 }
		}

		event_target:cybrex = {
			country_event = { id = crisis.2421 days = 4 }
			country_event = { id = crisis.2421 days = 120 }
			country_event = { id = crisis.2421 days = 320 }
			establish_communications_no_message = root
			establish_communications_no_message = event_target:cybrex_target
		}
	}
}

# # Cybrex Notification
# country_event = {
# 	id = crisis.2401
# 	title = "crisis.2401.name"
# 	desc = "crisis.2401.desc"
# 	# desc = {
# 	# 	text = "crisis.2401.desc"
# 	# 	trigger = { is_country_type = ai_empire }
# 	# }
# 	# desc = {
# 	# 	text ="crisis.2401.b.desc"
# 	# 	trigger = { is_country_type = gray_goo }
# 	# }

# 	picture = GFX_evt_physics_research
# 	show_sound = event_red_alert
# 	location = event_target:cybrex_beta

# 	is_triggered_only = yes

# 	option = {
# 		name = ONSCREEN
# 		hidden_effect = {
# 			country_event = { id = crisis.2402 }
# 			establish_communications_no_message = event_target:cybrex
# 			event_target:cybrex_beta = {
# 				every_system_planet = {
# 					set_surveyed = {
# 						surveyed = yes
# 						surveyor = root
# 					}
# 				}
# 			}
# 		}
# 	}
# }

# Final Machine World Destroyed
# id = crisis.2046
# Incoming Transmission
country_event = {
	id = crisis.2408
	title = "TRANSMISSION"
	desc = "crisis.2408.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = ai_crisis_2
		room = ship_room
	}

	is_triggered_only = yes

	option = {
		name = crisis.2408.a
	}
	after = {
		hidden_effect = {
			clear_global_event_target = cybrex
			remove_global_flag = cybrex_resurface
			remove_global_flag = cybrex_destroyed
			remove_country_flag = cybrex_donation
		}
	}
}

# Cybrex First Attacks (HIDDEN)
country_event = {
	id = crisis.2421
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		OR = {
			has_global_flag = ai_invasion_ongoing
			has_global_flag = gray_goo_crisis_active
		}
	}

	immediate = {
		# FIXME vanilla: not used anywhere, not finished?
		# random_country = { limit = { is_country_type = ai_empire }
		# 	save_event_target_as = contingency
		# }

		create_leader = {
			class = admiral
			species = owner_main_species
			name = random
			skill = 5
			traits = {
				trait = leader_trait_cybrex
			}
		}
		last_created_leader = { set_age = 0 }
		capital_scope = {
			# save_event_target_as = cybrex_home # FIXME vanilla: not used anywhere, not finished?
			create_fleet = {
				effect = {
					set_owner = prevprev
					while = {
						count = 10
						create_ship = {
							name = random
							design = "NAME_Taciturn"
							graphical_culture = "ai_01"
						}
					}
					assign_leader = last_created_leader
					while = {
						count = 20
						create_ship = {
							name = random
							design = "NAME_Reticent"
							graphical_culture = "ai_01"
						}
					}
					set_location = {
						target = prev
						distance = 45
						angle = random
					}

					save_event_target_as = cybrex_fleet
					set_aggro_range = 500
					set_fleet_stance = aggressive
					set_aggro_range_measure_from = self
					set_fleet_flag = cybrex_attack_fleet
				}
			}
		}
		country_event = {
			id = crisis.2421
			days = 1800
		}
	}
}

country_event = {
	# id = fallen_empires_awakening.3
	id = crisis.2003 #adt only
	title = OK
	desc = OK
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_country_type = awakened_gate_builders # awakened_fallen_empire
		if = { limit = { has_ethic = "ethic_fanatic_xenophile" }
			country_remove_ethic = "ethic_fanatic_xenophile"
		}
		if = { limit = { NOT = { has_ethic = "ethic_gestalt_consciousness" } }
			country_add_ethic = "ethic_gestalt_consciousness"
		}
		# authority = auth_ancient_machine_intelligence
		# civic = civic_revanchist_fervor
		# civic = civic_ancient_caches_of_technology
		change_government = {
			authority = auth_machine_intelligence
			civics = {
				civic = civic_awakened_machine
				civic = civic_final_defense_protocols
				civic = civic_machine_nanites_culture
			}
		}
		# set_name = "NAME_Graygoo_Consonance"
		# change_species_characteristics = {}
		species = {
			rename_species = {
				name = "NAME_Dessanu"
				# name_list = "MACHINE4"
			}
		}

		add_awakened_fallen_empire_resources = yes
		capital_scope = {
			prev.species = { set_species_homeworld = prev }
			starbase = { CmtEffectCreateAdmiralty_GraygooCapitalDefence = yes }
		}
		event_target:nanite_factory = {
			root = { CmtEffectCreateAdmiralty_GraygooRoamer = yes } # Roamers
		}
		set_origin = origin_machine_nanites
		# Establish communications
		every_country = {
			limit = {
				is_country_type_with_subjects = yes
				NOT = { has_communications = root }
			}
			establish_communications_no_message = root
			root = { save_event_target_as = contact_empire }
			country_event = { id = action.1 }
		}
		root = { save_event_target_as = awakened_machine_empire }
		if = { limit = { host_has_dlc = "Apocalypse" }
			give_technology = { tech = tech_colossus message = no }
		}

		change_country_flag = {
			icon = { category = "paradox" file = "paradox_logo.dds" }
			background = { category = "backgrounds" file = "sinus.dds" }
			colors = { "teal" "dark_grey" "null" "null" }
		}

		set_graphical_culture = "fallen_machine_empire_01" # temporary
		add_global_ship_design = "NAME_Omega"
		add_global_ship_design = "NAME_Alpha"
		add_global_ship_design = "NAME_Beta"
		add_global_ship_design = "NAME_Gamma"
		add_global_ship_design = "NAME_Theta"
		add_global_ship_design = "NAME_Tau"
		add_global_ship_design = "NAME_Sigma"
		add_global_ship_design = "NAME_FE_Starbase"
		create_ship_design = { design = "NAME_Omega" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Alpha" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Beta" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Gamma" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Theta" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Tau" }
		add_ship_design = last_created_design
		create_ship_design = { design = "NAME_Sigma" }
		add_ship_design = last_created_design
		# create_ship_design = { design = "NAME_FE_Starbase" }
		# add_ship_design = last_created_design
		# add_awakened_fallen_empire_fleet = yes
		event_target:nanite_factory = {
			create_fallen_empire_starting_navy = yes # galactic object
		}

		if = { limit = { has_origin = origin_machine_nanites }
			set_graphical_culture = "grey_tempesttw"
		} else = { set_graphical_culture = "machine_01" }
		create_fleet = {
			effect = {
				set_owner = root
				create_ship = {
					name = random
					design = "NAME_mardak_vol_haters_colossus"
					graphical_culture = owner
				}
				set_location = {
					# target = prev.capital_scope
					target = event_target:nanite_factory
					distance = 30
					angle = random
				}
			}
		}
		## colonize random planet
		random_system = {
			limit = {
				has_star_flag = lcluster
				has_owner = no
				NOR = {
					has_star_flag = lcluster_lgate
					has_star_flag = graygoo_factory_system
					# is_same_value = event_target:lcluster_factory_system
					any_fleet_in_system = { is_in_combat = yes }
				}
				any_system_planet = { is_planet_class = pc_gray_goo }
			}
			create_starbase = {
				size = "starbase_starport"
				owner = root
				module = "missile_battery"
				module = "gun_battery"
				building = "target_uplink_computer"
				effect = {
					while = { count = 4
						create_ship = { random_existing_design = military_station_small }
					}
				}
			}
			random_system_planet = {
				limit = { is_planet_class = pc_gray_goo has_owner = no }
				remove_modifier = terraforming_candidate
				## part.copy of graygoo.100
				root = { CmtEffectCreateAdmiralty_GraygooGarryson = yes }
				change_pc = pc_gaia
				reset_planet = yes
				set_planet_flag = hidden_nanite_world
				prevent_anomaly = yes
				set_owner = root

				add_deposit = d_energy_5
				add_deposit = d_natural_farmland
				add_deposit = d_minerals_2

				while = {
					count = 16
					create_pop = { species = owner_main_species }
				}
				while = {
					count = 2
					add_district_and_planet_size_if_needed_effect = {
						district = district_city
					}
				}
				while = {
					count = 3
					add_district_and_planet_size_if_needed_effect = {
						district = district_mining
					}
				}
				while = {
					count = 4
					add_district_and_planet_size_if_needed_effect = {
						district = district_generator
					}
				}
				if = {
					limit = {
						event_target:gate_builders.species = {
							is_lithoid = yes
						}
					}
					while = {
						count = 2
						add_district_and_planet_size_if_needed_effect = {
							district = district_mining
						}
					}
					add_district_and_planet_size_if_needed_effect = {
						district = district_generator
					}
				}
				else = {
					while = {
						count = 3
						add_district_and_planet_size_if_needed_effect = {
							district = district_farming
						}
					}
				}
				add_building = building_capital
				add_building = building_mineral_purification_hub
				add_building = building_energy_grid
				add_building = building_stronghold
				add_building = building_factory_1
				add_building = building_holo_theatres
				add_building = building_foundry_1

				create_army = {
					owner = root
					species = owner_main_species
					type = "nanite_giga_guardian"
				}
			}
		}
	}
}
