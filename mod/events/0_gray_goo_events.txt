############################################
#####									#####
#####	 Gray Goo/Dessanu Events		#####
#####	Replaced by A Deadly Tempest	#####
#####	Replaced by Crisis Manager		#####
#####	Vanilla by Henrik Thyrwall		#####
#####									#####
############################################

namespace = graygoo

###############
###	Graygoo	###
###############

###Invasion begins
country_event = {
	id = graygoo.1
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		### Pre-treatment
		set_global_flag = gray_goo_crisis_active

		# The guardians only awaken if there is a set_global_flag = galactic_crisis_happened !?
		awaken_guardians_of_the_galaxy = yes
		if = { limit = { end_game_years_passed >= 10 }
			# set_global_flag = galactic_crisis_happened # but this prevents other crisis?
			awaken_guardians_of_the_galaxy = yes
		}
		# vanilla double call?
		every_megastructure = {
			limit = { CmtTriggerIsClosedLgate = yes }
			CmtEffectOpenLgate = yes
		}
		# vanilla double call?
		if = {
			limit = { NOT = { exists = event_target:lcluster_factory_system } }
			random_system = {
				limit = { has_star_flag = graygoo_factory_system }
				save_global_event_target_as = lcluster_factory_system
			}
		}
		event_target:lcluster_factory_system = {
			random_system_planet = {
				limit = { has_planet_flag = main_star }
				save_event_target_as = main_star
			}
			random_system_planet = {
				limit = { is_planet_class = pc_gray_goo }
				# save_event_target_as = gray_homeworld
				create_species = {
					name = "NAME_Gray_Goo"
					class = "ESGO" #MACHINE
					portrait = lithnanite
					traits = {
						trait = "trait_machine_unit"
						trait = "trait_robot_enhanced_memory"
						trait = "trait_robot_superconductive"
						trait = "trait_robot_loyalty_circuits"
						trait = "trait_robot_mass_produced"
						trait = "trait_robot_durable"
						trait = "trait_robot_recycled"
						trait = "trait_robot_high_maintenance"
						trait = "trait_robot_uncanny"
					}
					homeworld = this
					immortal = yes
				}
			}
			create_country = {
				name = "NAME_Gray_Goo"
				type = "gray_goo"
				name_list = "graygoo"
				ignore_initial_colony_error = yes
				authority = "auth_machine_intelligence"
				species = last_created
				flag = {
					icon= {
						category = "special"
						file = "gray_goo.dds"
					}
					background= {
						category = "backgrounds"
						file = "sinus.dds"
					}
					colors = { "teal" "dark_grey" "null" "null" }
				}
				effect = {
					save_global_event_target_as = graygoo_country
					## add technologies
					country_event = { id = a_deadly_tempest.107 }
				}
			}
			event_target:main_star = { CmtEffectCreateNanitieFactory = yes }
			create_starbase = {
				size = "starbase_gatebuilders"
				owner = last_created_country
			}
		}

		### Create Fleets
		event_target:nanite_factory = {
			CmtEffectCreateAdmiralty_GraygooCapitalDefence = yes ## Garrison Fleets at Capital
			CmtEffectCreateAdmiralty_GraygooRoamer = yes ## Roamers
		}

		## Garisson Fleet for L-Cluster
		every_system = {
			limit = { has_star_flag = lcluster }
			every_system_planet = {
				limit = { is_planet_class = pc_gray_goo }
				CmtEffectCreateAdmiralty_GraygooGarryson = yes
			}
			# if = { limit = { has_star_flag = lcluster4 }
			# 	create_starbase = {
			# 		size = "starbase_gatebuilders"
			# 		owner = last_created_country
			# 	}
			# }
		}

		## Initial Attack Fleets
		every_system = {
			limit = {
				CmtTriggerIsGalaxyLgateSystem = yes
				NOT = { has_star_flag = lgate_originating_system }
				any_system_megastructure = { CmtTriggerIsOpenedLgate = yes }
			}
			random_system_megastructure = {
				limit = { CmtTriggerIsOpenedLgate = yes }
				CmtEffectCreateAdmiralty_GraygooAttackerA = yes
			}
		}

		## Reinforcement Fleets (Call AFTER Create Factory)
		event_target:graygoo_country = {
			country_event = { id = graygoo.3 days = 3600 }
			country_event = { id = a_deadly_tempest.105 days = 1800 } # Mothership creates ships
			set_country_flag = adtFlagActiveMothershipRebuild
		}

		### Notifications
		every_country = { establish_communications_no_message = event_target:graygoo_country }
		country_event = { id = graygoo.10 }
		every_playable_country = {
			# limit = { NOT = { is_same_value = root } }
			limit = { NOT = { has_country_flag = lcluster_opener } }
			if = {
				limit = {
					NOR = {
						has_event_chain = l_cluster_chain
						has_special_project = LCLUSTER_PROJECT
						#is_same_value = root
					}
				}
				country_event = { id = graygoo.13 }
			} else = {
				liquidate_clues = yes
				country_event = { id = graygoo.11 }
			}
		}
		observer_event = { id = observer.64 }
		## Make dragons friendly (sometimes not working so call it twice)
		country_event = { id = a_deadly_tempest.13006 days = 1 }
	}
}

# Colony Bombarded (From.From = ship)
planet_event = {
	id = graygoo.2
	#hide_window = yes
	title = "graygoo.2.name"
	desc = "graygoo.2.desc"
	picture = GFX_evt_gray_gooed_planet
	show_sound = event_ghost_town
	location = this
	is_triggered_only = yes

	trigger = {
		planet_devastation >= 100
		OR = {
			FROM = { is_country_type = gray_goo }
			has_orbital_bombardment_stance = nanitebombard
		}
	}

	immediate = {
		# small reinforce nanite bombarder
		random_fleet_in_orbit = {
			limit = {
				exists = owner
				owner = { is_same_empire = event_target:graygoo_country }
				# any_owned_ship = {
				is_ship_size = graygoo_mothership
			}
			CmtEffectCreateShip_GraygooInterdictor = yes
		}
		# destroy_colony = yes
		if = {
			limit = {
				NOR = {
					is_planet_class = pc_ringworld_habitable
					is_planet_class = pc_habitat
				}
			}
			change_pc = pc_gray_goo
			reset_planet = yes
			# Reset only removes real static modifiers? (2.7.2)
			# TODO which from 08_static_modifiers_megacorp.txt
			remove_modifier = planet_food_boost
			remove_modifier = planet_luxuries_boost
			remove_modifier = penal_colony
			remove_modifier = slave_colony
			remove_modifier = resort_colony
			remove_modifier = mastery_of_nature
			remove_modifier = artist_monument_erected
			remove_modifier = martial_law
			remove_modifier = hunter_killer_drones
			remove_modifier = compliance_protocols

			random_list = {
				4 = {}
				4 = { add_deposit = d_nanites_deposit }
				1 = { add_deposit = d_tomb_world_ruins }
				1 = { add_deposit = d_strip_mine }
				1 = { add_deposit = d_former_battlefield }
				1 = { add_deposit = d_failing_infrastructure }
				16 = {
					modifier = { NOT = { exists = owner } factor = 0 }
					generate_new_deposits_and_blockers = yes
				}
			}
		}
		else = {
			if = {
				limit = { is_planet_class = pc_ringworld_habitable }
				change_pc = pc_ringworld_habitable_damaged
				reset_planet = yes
			}
			if = {
				limit = { is_planet_class = pc_habitat }
				ariphaos_patch_remove_habitat = yes
			}
		}
		destroy_colony = yes

		# Sets a short timed flag if bombardment is going on, so the planet can be appropriately nuked.
		set_timed_planet_flag = {
			flag = flag_nanite_bombardment
			days = 6
		}
	}

	option = {
		name = graygoo.2.a
	}
}

### Reinforcements
country_event = {
	id = graygoo.3
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		OR = {
			AND = {
				exists = event_target:nanite_factory
				event_target:nanite_factory = { is_ship_size = graygoo_factory }
			}
			AND = {
				exists = event_target:lcluster_factory_system
				event_target:lcluster_factory_system = {
					any_fleet_in_system = { is_ship_size = graygoo_factory }
				}
			}
			# Savegame comp.
			any_system = {
				has_star_flag = graygoo_factory_system
				any_fleet_in_system = { is_ship_size = graygoo_factory }
			}
		}
		NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarReinforceCycle_Graygoo value = 1 } } }
	}

	immediate = {
		### Time Control
		if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarReinforceCycle_Graygoo value = 2 } } }
			country_event = { id = graygoo.3 days = 7200 }		## 20 yr
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarReinforceCycle_Graygoo value = 4 } } }
			country_event = { id = graygoo.3 days = 1800 }		## 5 yr
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarReinforceCycle_Graygoo value = 5 } } }
			country_event = { id = graygoo.3 days = 720 }		## 2 yr
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarReinforceCycle_Graygoo value = 6 } } }
			country_event = { id = graygoo.3 days = 360 }		## 1 yr
		} else = { country_event = { id = graygoo.3 days = 3600 } }		## 10 yr vanilla

		# Fallback (savegame comp.) re-save event_targets
		if = {
			limit = { NOT = { exists = event_target:nanite_factory } }
			# Savegame only (unknown reason)
			if = {
				limit = { NOT = { exists = event_target:lcluster_factory_system } }
				random_system = {
					limit = { has_star_flag = graygoo_factory_system }
					save_global_event_target_as = lcluster_factory_system
				}
			}

			event_target:lcluster_factory_system = {
				# random_system_planet = {
				# 	limit = { has_planet_flag = main_star }
				# 	save_event_target_as = main_star
				# }
				random_fleet_in_system = {
					limit = { is_ship_size = graygoo_factory }
					save_global_event_target_as = nanite_factory
				}
			}
			if = {
				limit = {
					NOT = { exists = event_target:graygoo_country }
					is_country_type = gray_goo
				}
				save_global_event_target_as = graygoo_country
			}
		}

		### Actual Effect
		if = {
			limit = { NOT = { has_global_flag = CmtFlagLgateOpenedNow } }
			if = {
				limit = {
					any_system = {
						has_star_flag = lcluster
						any_fleet_in_system = { owner = { NOT = { is_same_value = root } } }
					}
				}
				# Reinforce at factory if someone else is in the cluster...
				# AMOUNT integer 1 = 4 Ships per CM factor (so 3.0 = 12)
				event_target:nanite_factory = {
					if = { limit = { end_game_years_passed >= 30 }
						CmtEffectCreateAdmiralty_GraygooAttackerB = { AMOUNT = 4 }
					} else_if = { limit = { mid_game_years_passed >= 40 }
						CmtEffectCreateAdmiralty_GraygooAttackerB = { AMOUNT = 3 }
					} else_if = { limit = { mid_game_years_passed >= 10 }
						CmtEffectCreateAdmiralty_GraygooAttackerB = { AMOUNT = 2 }
					} else = {
						CmtEffectCreateAdmiralty_GraygooAttackerB = { AMOUNT = 1 }
					}
				}
				# Else spawn reinforcements...
			} else = {
				every_system = {
					limit = {
						CmtTriggerIsGalaxyLgateSystem = yes
						NOT = { has_star_flag = lgate_originating_system }
						any_system_megastructure = { CmtTriggerIsOpenedLgate = yes }
					}
					random_system_megastructure = {
						limit = { CmtTriggerIsOpenedLgate = yes }
						create_ambient_object = {
							type = "horror_spawn_object"
							location = THIS
							use_3d_location = yes
							duration = 10
						}
						if = { limit = { end_game_years_passed >= 30 }
							CmtEffectCreateAdmiralty_GraygooAttackerA = { AMOUNT = 4 }
							awaken_guardians_of_the_galaxy = yes
							awaken_fallen_machine_empire = yes
						} else_if = { limit = { mid_game_years_passed >= 40 }
							CmtEffectCreateAdmiralty_GraygooAttackerA = { AMOUNT = 3 }
						} else_if = { limit = { mid_game_years_passed >= 10 }
							CmtEffectCreateAdmiralty_GraygooAttackerA = { AMOUNT = 2 }
						} else = {
							CmtEffectCreateAdmiralty_GraygooAttackerA = { AMOUNT = 1 }
						}
					}
				}
			}
			# Savegame compat.
			if = { limit = { NOT = { has_country_flag = adtFlagActiveMothershipRebuild } }
				country_event = { id = a_deadly_tempest.105 days = 180 } # Mothership creates ships
				set_country_flag = adtFlagActiveMothershipRebuild
			}
		}
	}
}

# # Reinforcements 2
# country_event = {
# 	id = graygoo.4
# 	hide_window = yes

# 	is_triggered_only = yes

# 	immediate = {
# 		random_owned_ship = {
# 			limit = { is_ship_size = graygoo_factory }
# 			save_event_target_as = graygoo_factory
# 		}
# 		create_fleet = {
# 			name = "NAME_Tempest_Fleet"
# 			effect = {
# 				set_owner = event_target:graygoo_country
# 				create_graygoo_ships_1 = yes
# 				set_formation_scale = 2
# 				set_fleet_stance = aggressive
# 				set_aggro_range_measure_from = self
# 				set_aggro_range = 250
# 				set_location = {
# 					target = event_target:graygoo_factory
# 					distance = 10
# 					angle = random
# 				}
# 				set_fleet_flag = nanite_mother_ship
# 			}
# 		}
# 		create_fleet = {
# 			name = "NAME_Tempest_Fleet"
# 			effect = {
# 				set_owner = event_target:graygoo_country
# 				create_graygoo_ships_1 = yes
# 				set_formation_scale = 2
# 				set_fleet_stance = aggressive
# 				set_aggro_range_measure_from = self
# 				set_aggro_range = 250
# 				set_location = {
# 					target = event_target:graygoo_factory
# 					distance = 10
# 					angle = random
# 				}
# 				set_fleet_flag = nanite_mother_ship
# 			}
# 		}
# 		create_fleet = {
# 			name = "NAME_Tempest_Fleet"
# 			effect = {
# 				set_owner = event_target:graygoo_country
# 				create_graygoo_ships_1 = yes
# 				set_formation_scale = 2
# 				set_fleet_stance = aggressive
# 				set_aggro_range_measure_from = self
# 				set_aggro_range = 250
# 				set_location = {
# 					target = event_target:graygoo_factory
# 					distance = 10
# 					angle = random
# 				}
# 				set_fleet_flag = nanite_mother_ship
# 			}
# 		}
# 		country_event = { id = graygoo.3 days = 3600 }
# 	}
# }

# Claimed vanilla event is now graygoo.180
# Dreadnought Disabled/Destroyed (HIDDEN)
country_event = {
	id = graygoo.6
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_country_type = guardian_dreadnought
		has_country_flag = automated_dreadnought_country
		FROMFROM = { is_ship_size = npc_warship_01 }
		FROM = {
			is_ai = yes
			OR = {
				is_country_type = gate_builders
				is_country_type = gray_goo
				is_same_empire = event_target:graygoo_country
			}
		}
	}

	immediate = {
		destroy_country = yes
		every_country = {
			limit = {
				is_country_type = default
				has_modifier = automated_dreadnought_weak_points
			}
			remove_modifier = "automated_dreadnought_weak_points"
		}
		every_country = {
			limit = {
				is_country_type = default
				has_event_chain = curator_poi_chain
				event_target:guardians_dreadnought_system = {
					is_point_of_interest = {
						id = curator_poi_dreadnought
						event_chain = curator_poi_chain
						owner = prev
					}
				}
			}
			remove_point_of_interest = curator_poi_dreadnought
			end_curator_chain = yes
		}
		# Nanite Dreadnought
		FROM = {
			add_global_ship_design = "NAME_Type_69"
			create_ship_design = { design = "NAME_Type_69" }
			add_ship_design = last_created_design
		}
		FROMFROMFROM = {
			fleet = {
				create_ship = {
					name = random
					design = "NAME_Type_69"
					graphical_culture = "npf_01"
					upgradable = yes
				}
			}
		}
	}
}

# The Gray Tempest (Instigator)
country_event = {
	id = graygoo.10
	title = "graygoo.10.name"
	desc = {
		trigger = { NOT = { has_country_flag = only_one_lgate } }
		text = "graygoo.10.desc"
	}
	desc = {
		trigger = { has_country_flag = only_one_lgate }
		text = "graygoo.10.b.desc"
	}

	picture = GFX_evt_gray_goo_ships
	show_sound = event_radio_chatter

	is_triggered_only = yes

	option = {
		name = graygoo.10.a
		hidden_effect = {
			country_event = { id = graygoo.12 }
		}
	}
}

# The Gray Tempest (Other, has project/chain)
country_event = {
	id = graygoo.11
	title = "graygoo.10.name"
	desc = "graygoo.11.desc"
	picture = GFX_evt_gray_goo_ships
	show_sound = event_radio_chatter

	is_triggered_only = yes

	option = {
		name = graygoo.10.a
		hidden_effect = {
			country_event = { id = graygoo.12 }
		}
	}
}

# The Gray Tempest (Other, has nothing)
country_event = {
	id = graygoo.13
	title = "graygoo.10.name"
	desc = "graygoo.13.desc"
	picture = GFX_evt_gray_goo_ships
	show_sound = event_radio_chatter

	is_triggered_only = yes

	option = {
		name = graygoo.10.a
		hidden_effect = {
			country_event = { id = graygoo.12 }
		}
	}
}

# Incoming Transmission
country_event = {
	id = graygoo.12
	title = "TRANSMISSION"
	desc = "graygoo.12.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	option = {
		name = graygoo.12.a
		response_text = graygoo.12.a.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.12.b
		response_text = graygoo.12.b.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.12.c
		response_text = graygoo.12.c.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.12.d
	}
}

# Tempest Defeated (Instigator)
# country_event = {
# 	id = graygoo.15
# 	title = "graygoo.15.name"
# 	desc = "graygoo.15.desc"
# 	picture = GFX_evt_large_explosion
# 	show_sound = event_celebration
# 	location = event_target:goo_slayer_ship.fleet

# 	is_triggered_only = yes

# 	immediate = {
# 		set_global_flag = graygoo_defeated
# 	}

# 	option = {
# 		name = graygoo.15.a
# 		custom_tooltip = graygoo.15.a.tooltip
# 	}
# }

# Tempest Defeated (Others)
country_event = {
	id = graygoo.16
	title = "graygoo.15.name"
	desc = "graygoo.16.desc"
	picture = GFX_evt_large_explosion
	show_sound = event_celebration

	is_triggered_only = yes

	option = {
		name = GOOD
	}
}

###############
###	Dessanu	###
###############

### Set up Gray Goo Fallen Empire (Gate Builder)
country_event = {
	id = graygoo.100
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_megastructure = {
			limit = { CmtTriggerIsClosedLgate = yes }
			CmtEffectOpenLgate = yes
		}
		# vanilla double call?
		if = {
			limit = { NOT = { exists = event_target:lcluster_factory_system } }
			random_system = {
				limit = { has_star_flag = graygoo_factory_system }
				save_global_event_target_as = lcluster_factory_system
			}
		}
		### Create Country
		event_target:lcluster_factory_system = {
			random_system_planet = {
				limit = { has_planet_flag = main_star }
				save_event_target_as = main_star
			}
			random_list = {
				15 = {
					create_species = {
						name = "NAME_Dessanu"
						class = FUN #random_non_machine
						portrait = random #"sd_fun_robot"
						traits = { trait = random_traits }
						#homeworld = random
						immortal = yes
					}
				}
				15 = {
					create_species = {
						name = "NAME_Dessanu"
						class = LITHOID
						portrait = random
						traits = { trait = random_traits }
						immortal = yes
					}
				}
				15 = {
					create_species = {
						name = "NAME_Dessanu"
						class = PLANT
						portrait = random
						traits = { trait = random_traits }
						immortal = yes
					}
				}
				15 = {
					create_species = {
						name = "NAME_Dessanu"
						class = MOL
						portrait = random
						traits = { trait = random_traits }
						immortal = yes
					}
				}
				15 = {
					create_species = {
						name = "NAME_Dessanu"
						class = ESGO
						portrait = random
						traits = { trait = random_traits }
						immortal = yes
					}
				}
			}
			create_country = {
				name = "NAME_Dessanu_Consonance"
				type = "gate_builders"
				# name_list = "graygoo"
				ignore_initial_colony_error = yes
				authority = "auth_democratic"
				civics = {
					civic = civic_meritocracy
					civic = civic_environmentalist
				}
				species = last_created
				ethos = {
					ethic = "ethic_fanatic_xenophile"
					ethic = "ethic_egalitarian"
				}
				flag = {
					icon= {
						category = "paradox"
						file = "paradox_logo_90.dds"
					}
					background= {
						category = "backgrounds"
						file = "sinus.dds"
					}
					colors= { "teal" "dark_grey" "null" "null" }
				}
				origin = "origin_fallen_empire"
				# origin = "origin_life_seeded"
				effect = {
					save_global_event_target_as = graygoo_country
					set_graphical_culture = "machine_01"
					add_resource = {
						minerals = 5000
						energy = 10000
						influence = 5000
						nanites = 50000
					}
					# species = {
					# 	change_species_characteristics = {
					# 		immortal = yes
					# 		# new_pop_resource_requirement = { type = food_surplus value = 0 }
					# 	}
					# }
					modify_species = {
						species = species
						add_trait = trait_machine_unit
						add_trait = trait_mechanical
						add_traits_at_start_of_list = yes
						# ideal_planet_class = pc_gray_goo
						change_scoped_species = yes
					}

					## add technologies
					country_event = { id = a_deadly_tempest.107 }
				}
			}
			### Create Factory/Fleets/Starbases
			event_target:main_star = { CmtEffectCreateNanitieFactory = yes }
		}

		every_country = { establish_communications_no_message = event_target:graygoo_country }

		event_target:nanite_factory = {
			CmtEffectCreateAdmiralty_DessanuCapitalDefence = yes	# Garrison Fleets at Capital
			CmtEffectCreateAdmiralty_DessanuRoamer = yes # Roamers
		}

		### Change Planet to Gaia, Create Buildings, Orbital Station
		every_system = {
			limit = { has_star_flag = lcluster }
			create_starbase = {
				size = "starbase_gatebuilders"
				owner = event_target:graygoo_country
			}
			every_system_planet = {
				limit = {
					has_deposit_for = shipclass_mining_station
				}
				create_mining_station = { owner = event_target:graygoo_country }
			}
			every_system_planet = {
				limit = {
					has_deposit_for = shipclass_research_station
				}
				create_research_station = { owner = event_target:graygoo_country }
			}
			every_system_planet = {
				limit = { is_planet_class = pc_gray_goo }
				CmtEffectCreateAdmiralty_DessanuGarryson = yes
				change_pc = pc_gaia
				reset_planet = yes
				set_planet_flag = hidden_nanite_world
				prevent_anomaly = yes
				set_owner = event_target:graygoo_country

				add_deposit = d_energy_5
				add_deposit = d_natural_farmland
				add_deposit = d_minerals_2

				while = {
					count = 30
					create_pop = { species = owner_main_species }
				}
				while = {
					count = 2
					add_district_and_planet_size_if_needed_effect = {
						district = district_city
					}
				}
				while = {
					count = 3
					add_district_and_planet_size_if_needed_effect = {
						district = district_mining
					}
				}
				while = {
					count = 4
					add_district_and_planet_size_if_needed_effect = {
						district = district_generator
					}
				}
				if = {
					limit = {
						event_target:graygoo_country.species = {
							is_lithoid = yes
						}
					}
					while = {
						count = 2
						add_district_and_planet_size_if_needed_effect = {
							district = district_mining
						}
					}
					add_district_and_planet_size_if_needed_effect = {
						district = district_generator
					}
				}
				else = {
					while = {
						count = 3
						add_district_and_planet_size_if_needed_effect = {
							district = district_farming
						}
					}
				}
				add_building = building_capital
				add_building = building_mineral_purification_hub
				add_building = building_energy_grid
				add_building = building_stronghold
				add_building = building_factory_1
				add_building = building_holo_theatres
				add_building = building_foundry_1

				create_army = {
					owner = event_target:graygoo_country
					species = last_created
					type = "nanite_giga_guardian"
				}
			}
		}
		country_event = { id = graygoo.110 }
		observer_event = { id = observer.66 }
	}
}

### The Dessanu Consonance Introduction (Opener)
country_event = {
	id = graygoo.110
	title = "distar.10951.name"
	desc = "graygoo.110.desc"
	picture = GFX_evt_l-gateway
	show_sound = event_radio_chatter

	is_triggered_only = yes

	after = {
		hidden_effect = {
			every_playable_country = {
				limit = { NOT = { is_same_value = root } }
				# limit = { NOT = { has_country_flag = lcluster_opener } }
				if = {
					limit = {
						OR = {
							is_researching_technology = tech_lgate_activation
							has_technology = tech_lgate_activation
							has_special_project = LCLUSTER_PROJECT
						}
					}
					set_country_flag = CmtFlagLgateOpenFinalPhase
				}
				if = {
					limit = {
						OR = {
							has_special_project = LCLUSTER_PROJECT
							has_event_chain = l_cluster_chain
						}
					}
					country_event = { id = graygoo.111 }
				} else = { country_event = { id = graygoo.112 } }
			}
		}
	}

	option = {
		name = graygoo.10.a
		hidden_effect = {
			country_event = { id = graygoo.115 }
		}
	}
}

# Dessanu Introduction (Other, has project/chain)
country_event = {
	id = graygoo.111
	title = "graygoo.111.name"
	desc = "graygoo.111.desc"
	picture = GFX_evt_l-gateway
	show_sound = event_radio_chatter

	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				is_ai = no
				NOT = { has_communications = from }
			}
			establish_communications_no_message = from
		}
		establish_communications_no_message = event_target:graygoo_country
	}

	option = {
		name = ONSCREEN
		hidden_effect = {
			country_event = { id = graygoo.116 }
		}
	}
}

# Dessanu Introduction (Other, has nothing)
country_event = {
	id = graygoo.112
	title = "graygoo.111.name"
	desc = "graygoo.112.desc"
	picture = GFX_evt_l-gateway
	show_sound = event_radio_chatter

	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				is_ai = no
				NOT = { has_communications = from }
			}
			establish_communications_no_message = from
		}
		establish_communications_no_message = event_target:graygoo_country
	}

	option = {
		name = ONSCREEN
		hidden_effect = {
			country_event = { id = graygoo.116 }
		}
	}
}

### Incoming Transmission (Opener)
country_event = {
	id = graygoo.115
	title = "TRANSMISSION"
	desc = "graygoo.115.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:graygoo_country
	}

	is_triggered_only = yes

	option = {
		name = graygoo.115.a
		response_text = graygoo.115.a.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.115.b
		response_text = graygoo.115.b.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.115.c
		response_text = graygoo.115.c.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.115.d
		response_text = graygoo.115.d.response
		default_hide_option = yes
		if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateDessanuGift value = 2 } } }
			CmtEffectAddDessanuGift2 = yes
		} else_if = {
			limit = { NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateDessanuGift value = 1 } } } }
			CmtEffectAddDessanuGift4 = yes
		}
		if = {
			limit = { NOT = { has_technology = tech_mine_living_metal } }
			 give_technology = { tech = tech_mine_living_metal }
		}
	}
}

# Incoming Transmission (Everyone Else)
country_event = {
	id = graygoo.116
	title = "TRANSMISSION"
	desc = "graygoo.116.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:graygoo_country
	}

	is_triggered_only = yes

	option = {
		name = graygoo.116.d
		if = {
			limit = {
				event_target:CmtGlobalVar = {
					OR = {
						check_variable = { which = CmtVarLgateDessanuGift value = 4 }
						check_variable = { which = CmtVarLgateDessanuGift value = 5 }
					}
				}
				has_country_flag = CmtFlagLgateOpenFinalPhase
			}
			CmtEffectAddDessanuGift2 = yes
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateDessanuGift value = 5 } } }
			CmtEffectAddDessanuGift1 = yes
		} else_if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateDessanuGift value = 6 } } }
			CmtEffectAddDessanuGift4 = yes
		}
	}
}

# Dessanu Diplomacy (Initial)
country_event = {
	id = graygoo.120
	title = "graygoo.120_title"
	desc = {
		text = graygoo.120.desc_01
	}
	desc = {
		text = graygoo.120.desc_02
	}
	desc = {
		text = graygoo.120.desc_03
	}
	desc = {
		text = graygoo.120.desc_04
	}
	desc = {
		text = graygoo.120.desc_05
	}
	desc = {
		text = graygoo.120.desc_06
	}
	desc = {
		text = graygoo.120.desc_07
	}

	picture_event_data = {
		portrait = from
	}

	diplomatic = yes
	force_open = yes
	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gate_builders }
		NOR = {
			has_country_flag = gate_builder_diplomacy_engaged
			has_country_flag = gate_builders_hostility
		}
	}

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
		from = { save_event_target_as = gate_builders }
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.120.a
		country_event = { id = graygoo.121 }
	}
	option = {
		default_hide_option = yes
		name = graygoo.115.d
	}
}

# Dessanu Diplomacy
country_event = {
	id = graygoo.119
	title = "graygoo.120_title"
	desc = {
		text = graygoo.120.desc_01
	}
	desc = {
		text = graygoo.120.desc_02
	}
	desc = {
		text = graygoo.120.desc_03
	}
	desc = {
		text = graygoo.120.desc_04
	}
	desc = {
		text = graygoo.120.desc_05
	}
	desc = {
		text = graygoo.120.desc_06
	}
	desc = {
		text = graygoo.120.desc_07
	}

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	diplomatic = yes
	force_open = yes
	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = gate_builder_diplomacy_engaged }
	}

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.120.a
		country_event = { id = graygoo.121 }
	}
	option = {
		default_hide_option = yes
		name = graygoo.115.d
	}
}

# Tell us about yourselves
country_event = {
	id = graygoo.121
	title = "graygoo.120_title"
	desc = "graygoo.121.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.121.a
		response_text = graygoo.121.a.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.121.b
		response_text = graygoo.121.b.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.121.c
		response_text = graygoo.121.c.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.121.d
		hidden_effect = {
			country_event = { id = graygoo.122 }
		}
	}
	option = {
		name = graygoo.121.e
		default_hide_option = yes
		hidden_effect = {
			country_event = { id = graygoo.119 }
		}
	}
}

# Inquire about Nanites
country_event = {
	id = graygoo.122
	title = "graygoo.120_title"
	desc = "graygoo.122.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.122.a
		hidden_effect = {
			country_event = { id = graygoo.123 }
		}
	}
	option = {
		name = graygoo.122.b
		default_hide_option = yes
		hidden_effect = {
			country_event = { id = graygoo.121 }
		}
	}
}

# Inquire about Nanites 2
country_event = {
	id = graygoo.123
	title = "graygoo.120_title"
	desc = "graygoo.123.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.123.a
		hidden_effect = {
			country_event = { id = graygoo.124 }
		}
	}
	option = {
		name = graygoo.123.b
		default_hide_option = yes
		hidden_effect = {
			country_event = { id = graygoo.121 }
		}
	}
}

# Inquire about Nanites 3
country_event = {
	id = graygoo.124
	title = "graygoo.120_title"
	desc = "graygoo.124.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.124.a
		hidden_effect = {
			country_event = { id = graygoo.125 }
		}
	}
}

# Inquire about Nanites 4
country_event = {
	id = graygoo.125
	title = "graygoo.120_title"
	desc = "graygoo.124.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.125.a
		hidden_effect = {
			country_event = { id = graygoo.126 }
		}
	}
}

# Inquire about Nanites 5
country_event = {
	id = graygoo.126
	title = "graygoo.120_title"
	desc = "graygoo.126.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	immediate = {
		country_event = { id = a_deadly_tempest.162 }
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.126.a
	}
}

# Dessanu Hostile Diplomacy
country_event = {
	id = graygoo.130
	title = "graygoo.120_title"
	desc = "graygoo.130.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = from
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gate_builders }
		NOT = { has_country_flag = gate_builder_diplomacy_engaged }
		has_country_flag = gate_builders_hostility
	}

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.130.a
		response_text = graygoo.130.desc
		is_dialog_only = yes
	}
	option = {
		name = graygoo.130.b
		response_text = graygoo.130.desc
		is_dialog_only = yes
	}
	option = {
		name = graygoo.130.c
		response_text = graygoo.130.desc
		is_dialog_only = yes
	}
	option = {
		name = graygoo.130.d
		response_text = graygoo.130.desc
		is_dialog_only = yes
	}
	option = {
		name = graygoo.130.e
		default_hide_option = yes
	}
}

### Invaded Dessanu Planet
country_event = {
	id = graygoo.150
	title = graygoo.150.name
	desc = {
		trigger = { NOT = { has_country_flag = invaded_graygoo_planet } }
		text = graygoo.150.a.desc
	}
	desc = {
		trigger = { has_country_flag = invaded_graygoo_planet }
		text = graygoo.150.b.desc
	}
	picture = {
		trigger = { NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateTerraformNanite value = 5 } } } }
		picture = GFX_evt_gray_goo
	}
	picture = {
		trigger = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateTerraformNanite value = 5 } } }
		picture = GFX_evt_gaia
	}

	show_sound = event_ground_battle
	location = fromfrom

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gate_builders }
	}

	immediate = {
		fromfrom = {
			#remove_all_buildings = yes
			destroy_colony = yes
			if = {
				limit = { NOT = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateTerraformNanite value = 5 } } } }
				change_pc = pc_gray_goo
				reroll_planet = yes
				if = {
					limit = {
						event_target:CmtGlobalVar = {
							NOR = {
								check_variable = { which = CmtVarLgateTerraformNanite value = 1 }
								check_variable = { which = CmtVarLgateTerraformNanite value = 2 }
								check_variable = { which = CmtVarLgateTerraformNanite value = 3 }
							}
						}
					}
					add_modifier = { modifier = terraforming_candidate days = -1 }
				}
			}
		}
	}

	after = {
		hidden_effect = {
			if = {
				limit = { NOT = { has_country_flag = invaded_graygoo_planet } }
				set_country_flag = invaded_graygoo_planet
			}
		}
	}

	option = {
		name = graygoo.150.a
		hidden_effect = {
			country_event = { id = graygoo.156 days = 3 }
		}
	}
}

# Turned Hostile (Space Battle)
country_event = {
	id = graygoo.155
	title = TRANSMISSION
	desc = "graygoo.155.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = from
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gate_builders }
		NOT = { has_country_flag = gate_builders_hostility }
	}

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
		set_country_flag = gate_builders_hostility
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.155.a
	}
}

# Turned Hostile (Ground Battle)
country_event = {
	id = graygoo.156
	title = TRANSMISSION
	desc = "graygoo.155.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = fromfrom
	}

	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = gate_builders_hostility }
	}

	immediate = {
		set_country_flag = gate_builder_diplomacy_engaged
		set_country_flag = gate_builders_hostility
	}

	after = {
		hidden_effect = { remove_country_flag = gate_builder_diplomacy_engaged }
	}

	option = {
		name = graygoo.155.a
	}
}

# Entered Factory System (First Time)
country_event = {
	id = graygoo.158
	title = leviathans.2105.name
	desc = leviathans.2105.desc
	picture = GFX_evt_enigmatic_fortress
	show_sound = event_ship_bridge
	location = event_target:nanite_factory
	is_triggered_only = yes
	immediate = {}
	option = {
		name = leviathans.2105.a # leviathans.2101.b
	}
}

# Entered Forbidden System (First Time)
country_event = {
	id = graygoo.159
	title = TRANSMISSION
	title = leviathans.2105.name
	desc = graygoo.160.desc
	diplomatic = yes
	picture_event_data = {
		portrait = event_target:gate_builders
	}
	is_triggered_only = yes

	# trigger = {
	# 	from.space_owner = { is_country_type = gate_builders }
	# }

	immediate = {
		random_country = {
			limit = { is_country_type = gate_builders }
			save_event_target_as = gate_builders
		}
		set_country_flag = gate_builder_diplomacy_engaged
	}

	option = {
		name = graygoo.160.a
		hidden_effect = {
			set_timed_country_flag = { flag = gk_told_to_leave days = 60 }
			set_country_flag = gk_first_entry
			country_event = { id = graygoo.161 days = 60 }
		}
	}
	option = {
		name = graygoo.160.b
		response_text = graygoo.160.b.response
		hidden_effect = {
			country_event = { id = a_deadly_tempest.162 }
		}
	}

	after = {
		hidden_effect = {
			remove_country_flag = gate_builder_diplomacy_engaged
		}
	}
}

# Entered Forbidden System (First Time)
ship_event = {
	id = graygoo.160
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		from = {
			has_star_flag = graygoo_factory_system
			any_fleet_in_system = {
				is_ship_size = graygoo_factory
				owner = {
					OR = {
						is_country_type = gray_goo
						is_country_type = gate_builders
					}
				}
			}
		}
		owner = {
			NOT = { has_country_flag = gate_builders_hostility }
		}
	}

	immediate = {
			FROM = { save_event_target_as = fortress_system }

			if = { limit = { NOT = { exists = event_target:nanite_factory } }
				from = {
					random_fleet_in_system = {
						limit = { is_ship_size = graygoo_factory }
						save_global_event_target_as = nanite_factory
					}
				}
			}
			owner = { country_event = { id = graygoo.158 } }

			if = {
				limit = { event_target:nanite_factory = { owner = { is_country_type = gate_builders } } }
				owner = { country_event = { id = graygoo.159 days = 1 } }
			}
		}
	}
}

# Failed to leave
country_event = {
	id = graygoo.161
	title = TRANSMISSION
	desc = "graygoo.161.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = gate_builders_hostility }
		event_target:lcluster_factory_system = {
			any_fleet_in_system = {
				owner = { is_same_value = root is_country_type = gate_builders }
				is_ship_size = graygoo_factory
			}
		}
	}

	immediate = {
		country_event = { id = a_deadly_tempest.162 }
	}

	after = {
		hidden_effect = {
			remove_country_flag = gate_builder_diplomacy_engaged
		}
	}

	option = {
		name = graygoo.161.a
	}
}

# Entered Base System (Second Time)
fleet_event = {
	id = graygoo.162
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		from = {
			has_star_flag = graygoo_factory_system
			any_fleet_in_system = {
				is_ship_size = graygoo_factory
				NOT = { owner = { is_same_empire = root.owner } }
			}
		}
	}

	immediate = {
		# graygoo_country fallback
		if = { limit = { NOT = { exists = event_target:graygoo_country } }
			random_country = {
				limit = {
					OR = {
						is_country_type = gray_goo
						is_country_type = gate_builders
					}
				}
				save_global_event_target_as = graygoo_country
			}
		}
		# nanite_factory fallback (savegame comp.)
		if = { limit = { NOT = { exists = event_target:nanite_factory } }
			from = {
				random_fleet_in_system = {
					limit = { is_ship_size = graygoo_factory }
					save_global_event_target_as = nanite_factory
				}
			}
		}

		if = {
			limit = {
				exists = event_target:nanite_factory
				event_target:nanite_factory = {
					exists = owner
					owner = { is_country_type = gate_builders }
				}
			}
			if = {
				limit = {
					owner = {
						NOR = {
							has_country_flag = gate_builders_hostility
							has_country_flag = gk_told_to_leave
							has_country_flag = violating_gatebuilder_space
						}
					}
				}
				fleet_event = { id = graygoo.163 }
			} else_if = { limit = { fleet_power > 21000 }
				event_target:graygoo_country = {
					country_event = { id = a_deadly_tempest.96 } # run patrol
				}
			}
		} else_if = { limit = { fleet_power > 21000 }
			event_target:graygoo_country = {
				country_event = { id = a_deadly_tempest.96 } # run patrol
			}
		}
	}
}

# Entered Forbidden System (Second Time)
fleet_event = {
	id = graygoo.163
	title = TRANSMISSION
	desc = "graygoo.162.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gate_builders
	}

	fire_only_once = yes

	trigger = {
		# from = {
		# 	has_star_flag = graygoo_factory_system
		# 	any_fleet_in_system = {
		# 		is_ship_size = graygoo_factory
		# 		owner = { is_country_type = gate_builders }
		# 	}
		# }
		owner = {
			has_country_flag = gk_first_entry
			# NOR = {
			# 	has_country_flag = gate_builders_hostility
			# 	has_country_flag = gk_told_to_leave
			# 	has_country_flag = violating_gatebuilder_space
			# }
		}
	}

	immediate = {
		random_country = {
			limit = { is_country_type = gate_builders }
			save_event_target_as = gate_builders
		}
		owner = {
			set_country_flag = gate_builder_diplomacy_engaged
			set_country_flag = violating_gatebuilder_space
		}
	}

	after = {
		hidden_effect = {
			owner = {
				remove_country_flag = gate_builder_diplomacy_engaged
				remove_country_flag = violating_gatebuilder_space
			}
		}
	}

	option = {
		name = graygoo.162.a
		hidden_effect = {
			owner = {
				set_timed_country_flag = { flag = gk_told_to_leave days = 60 }
				country_event = { id = graygoo.161 days = 60 }
			}
		}
	}
	option = {
		name = graygoo.162.b
		response_text = graygoo.160.b.response
		hidden_effect = {
			owner = { country_event = { id = a_deadly_tempest.162 } }
		}
	}
}

# Factory Destroyed (Dessanu/Graygoo)
# This = owner of ship 1 (destroyed)
# From = owner of ship 2 (combatant)
# FromFrom = ship 1
# FromFromFrom = ship 2
country_event = {
	id = graygoo.180
	hide_window = yes
	picture = GFX_evt_exploding_ship
	show_sound = event_super_explosion
	location = this

	is_triggered_only = yes

	trigger = {
		OR = {
			is_country_type = gate_builders
			is_country_type = gray_goo
			is_same_empire = event_target:graygoo_country
		}
		fromfrom = { is_ship_size = graygoo_factory }
	}

	immediate = {
		fromfromfrom = { save_event_target_as = goo_slayer_ship }
		from = {
			# ADT: Used later
			# set_country_flag = goo_slayer
			save_global_event_target_as = goo_slayer
			# Give tech
			country_event = { id = a_deadly_tempest.7 days = 1 }
		}

		if = {
			limit = { is_country_type = gray_goo }
			CmtEffectDestroyGraygoo = yes # call graygoo.15
			break = yes
		}

		from = { country_event = { id = graygoo.181 } }
		every_playable_country = {
			limit = {
				is_ai = no
				NOT = { is_same_empire = event_target:goo_slayer }
			}
			country_event = { id = graygoo.182 }
		}

		observer_event = { id = observer.67 }
		## Change Gaia Planet to Graygoo
		if = {
			limit = { event_target:CmtGlobalVar = { check_variable = { which = CmtVarLgateTerraformNanite value = 5 } } }
			every_owned_planet = {
				limit = { is_planet_class = pc_gaia }
				remove_all_buildings = yes
				every_owned_pop = { kill_pop = yes }
				generate_new_deposits_and_blockers = yes
				destroy_colony = yes
			}
			every_planet = {
				limit = { is_planet_class = pc_gray_goo has_planet_flag = hidden_nanite_world }
				add_modifier = { modifier = terraforming_candidate days = -1 }
				remove_planet_flag = hidden_nanite_world
			}
		} else_if = {
			limit = {
				event_target:CmtGlobalVar = {
					OR = {
						check_variable = { which = CmtVarLgateTerraformNanite value = 1 }
						check_variable = { which = CmtVarLgateTerraformNanite value = 2 }
						check_variable = { which = CmtVarLgateTerraformNanite value = 3 }
					}
				}
			}
			every_owned_planet = {
				limit = { is_planet_class = pc_gaia has_planet_flag = hidden_nanite_world }
				change_pc = pc_gray_goo
				remove_all_buildings = yes
				every_owned_pop = { kill_pop = yes }
				destroy_colony = yes
				reroll_planet = yes
				generate_new_deposits_and_blockers = yes
				remove_planet_flag = hidden_nanite_world
			}
		} else = {
			every_owned_planet = {
				limit = { is_planet_class = pc_gaia has_planet_flag = hidden_nanite_world }
				change_pc = pc_gray_goo
				remove_all_buildings = yes
				every_owned_pop = { kill_pop = yes }
				reroll_planet = yes
				generate_new_deposits_and_blockers = yes
				destroy_colony = yes
				add_modifier = { modifier = terraforming_candidate days = -1 }
				remove_planet_flag = hidden_nanite_world
			}
		}
		every_owned_fleet = { destroy_fleet = this }
		# pop is not removed automatically
		every_owned_pop = {
			kill_pop = yes
		}
		# kill also every not owned pop!?
		every_galaxy_pop = {
			limit = { is_exact_same_species = root.species }
			kill_pop = yes
		}
		destroy_country = yes
		clear_global_event_target = graygoo_country
		clear_global_event_target = nanite_factory
	}
}

### Factory Destroyed, Instigator (Dessanu)
country_event = {
	id = graygoo.181
	title = "graygoo.181.name"
	desc = "graygoo.181.desc"
	picture = GFX_evt_large_explosion
	show_sound = event_super_explosion
	location = event_target:lcluster_factory_system

	is_triggered_only = yes

	option = {
		name = INTERESTING
		if = {
			limit = { CmtTriggerHasDessanuGift = yes }
			CmtEffectRemoveDessanuGift = yes
		}
	}
}

### Factory Destroyed, Others (Dessanu)
country_event = {
	id = graygoo.182
	title = "graygoo.181.name"
	desc = {
		trigger = { NOT = { has_modifier = dessanu_gift } }
		text = graygoo.182.a.desc
	}
	desc = {
		trigger = { has_modifier = dessanu_gift }
		text = graygoo.182.b.desc
	}
	picture = GFX_evt_large_explosion
	show_sound = event_ship_explosion

	is_triggered_only = yes

	after = {
		if = {
			limit = { CmtTriggerHasDessanuGift = yes }
			CmtEffectRemoveDessanuGift = yes
		}
	}

	option = {
		name = graygoo.182.a
	}
}

### Dessanu Gift terminated due to hostility (HIDDEN)
event = {
	id = graygoo.183
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		exists = event_target:graygoo_country
		any_playable_country = {
			CmtTriggerHasDessanuGift = yes
			event_target:graygoo_country = { is_hostile = prev }
		}
	}

	immediate = {
		random_playable_country = {
			limit = {
				CmtTriggerHasDessanuGift = yes
				event_target:graygoo_country = { is_hostile = prev }
			}
			country_event = { id = graygoo.184 }
		}
	}
}

# Dessanu Gift terminated due to hostility
country_event = {
	id = graygoo.184
	title = "graygoo.184.name"
	desc = "graygoo.184.desc"
	picture = GFX_evt_gray_goo_ships
	show_sound = event_radio_chatter

	is_triggered_only = yes

	immediate = {
		if = {
			limit = { CmtTriggerHasDessanuGift = yes }
			CmtEffectRemoveDessanuGift = yes
		}
	}

	option = {
		name = graygoo.184.a
		tooltip = { CmtEffectRemoveDessanuGift = yes }
	}
}

### Gray

# Encountered Gray
ship_event = {
	id = graygoo.400
	title = "graygoo.400.name"
	desc = {
		trigger = {
			owner = { NOT = { has_authority = auth_machine_intelligence } }
		}
		text = "graygoo.400.a.desc"
	}
	desc = {
		trigger = { owner = { has_authority = auth_machine_intelligence } }
		text = "graygoo.400.b.desc"
	}
	picture = GFX_evt_ship_in_orbit_2
	show_sound = event_radio_chatter

	is_triggered_only = yes
	# To everyone except goo_slayer
	trigger = {
		owner = {
			NOR = {
				OR = {
					exists = event_target:graygoo_country
					AND = { exists = event_target:goo_slayer is_same_value = event_target:goo_slayer }
				}
				is_country_type = gate_builders
			}
		}
	}

	immediate = {
		from = { save_event_target_as = gray_homeworld }
	}

	option = {
		name = graygoo.400.a
		hidden_effect = {
			owner = {
				country_event = { id = graygoo.401 }
			}
		}
	}
}

# Gray 1
country_event = {
	id = graygoo.401
	title = "TRANSMISSION"
	desc = {
		trigger = { NOT = { has_authority = auth_machine_intelligence } }
		text = "graygoo.401.a.desc"
	}
	desc = {
		trigger = { has_authority = auth_machine_intelligence }
		text = "graygoo.401.b.desc"
	}

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.401.a
		trigger = {
			NOR = {
				has_authority = auth_machine_intelligence
				has_authority = auth_hive_mind
			}
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
	option = {
		name = graygoo.401.b
		trigger = {
			has_authority = auth_machine_intelligence
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
	option = {
		name = graygoo.401.c
		trigger = {
			has_authority = auth_hive_mind
		}
		hidden_effect = {
			country_event = { id = graygoo.402 }
		}
	}
}

# Gray 2
country_event = {
	id = graygoo.402
	title = "TRANSMISSION"
	desc = {
		trigger = { NOT = { has_authority = auth_machine_intelligence } }
		text = "graygoo.402.a.desc"
	}
	desc = {
		trigger = { has_authority = auth_machine_intelligence }
		text = "graygoo.402.b.desc"
	}

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.402.a
		hidden_effect = {
			country_event = { id = graygoo.403 }
		}
	}
}

# Gray 3
country_event = {
	id = graygoo.403
	title = "TRANSMISSION"
	desc = "graygoo.403.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.403.a
		hidden_effect = {
			country_event = { id = graygoo.404 }
		}
	}
}

# Gray 4
country_event = {
	id = graygoo.404
	title = "TRANSMISSION"
	desc = "graygoo.404.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.404.a
		hidden_effect = {
			country_event = { id = graygoo.405 }
		}
	}
}

# Gray 5
country_event = {
	id = graygoo.405
	title = "TRANSMISSION"
	desc = "graygoo.405.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.405.a
		hidden_effect = {
			country_event = { id = graygoo.406 }
		}
	}
	option = {
		name = graygoo.405.b
		response_text = graygoo.405.b.response
	}
}

# Gray 6
country_event = {
	id = graygoo.406
	title = "TRANSMISSION"
	desc = "graygoo.406.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = root.species
		room = "ethic_spaceship_room"
	}

	is_triggered_only = yes

	option = {
		name = graygoo.406.a
		response_text = graygoo.406.a.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.406.b
		response_text = graygoo.406.b.response
		is_dialog_only = yes
	}
	option = {
		name = graygoo.406.c
		response_text = graygoo.406.c.response
		default_hide_option = yes
		hidden_effect = {
			country_event = { id = graygoo.499 }
		}
	}
}

# Create Gray
country_event = {
	id = graygoo.499
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = gray_diplomacy_engaged }
	}
	immediate = {
		create_species = {
			name = "NAME_Gray"
			class = "ESGO"
			portrait = root.species
			traits = {
				trait = "trait_machine_unit"
				trait = "trait_robot_enhanced_memory"
				trait = "trait_robot_superconductive"
				trait = "trait_robot_loyalty_circuits"
				trait = "trait_robot_mass_produced"
				trait = "trait_robot_durable"
				trait = "trait_robot_recycled"
				trait = "trait_robot_high_maintenance"
				trait = "trait_robot_uncanny"
			}
			homeworld = event_target:gray_homeworld
			immortal = yes
		}

		create_country = {
			name = "NAME_Gray"
			type = "gray"
			name_list = "graygoo"
			ignore_initial_colony_error = yes
			flag = {
				icon= {
					category = "special"
					file = "gray_goo.dds"
				}
				background= {
					category = "backgrounds"
					file = "sinus.dds"
				}
				colors={ "grey" "dark_grey" "null" "null" }
			}
			effect = {
				save_global_event_target_as = graygoo_country
				set_graphical_culture = root
				## add technologies
				country_event = { id = a_deadly_tempest.107 }
			}
		}
		last_created_country = {
			establish_communications_no_message = root
		}
		save_global_event_target_as = gray_owner
	}
}

# Main Menu (Initial)
country_event = {
	id = graygoo.500
	title = "graygoo.500.title"
	desc = "graygoo.500.a.desc"
	desc = "graygoo.500.b.desc"
	desc = "graygoo.500.c.desc"
	desc = "graygoo.500.d.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	trigger = {
		NOT = { has_country_flag = gray_diplomacy_engaged }
	}

	immediate = {
		set_country_flag = gray_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gray_diplomacy_engaged }
	}

	trigger = {
		from = { is_country_type = gray }
		is_same_value = event_target:gray_owner
		NOR = {
			has_country_flag = gray_governor_active
			has_country_flag = gray_warship_active
			has_country_flag = gray_army_active
			has_country_flag = gray_reforming
		}
	}

	option = { # Governor
		name = graygoo.500.a
		response_text = graygoo.500.a.response
		trigger = {
			NOT = { has_country_flag = gray_governor_active }
		}
		hidden_effect = {
			create_gray_governor = yes
		}
	}
	option = { # Warship
		name = graygoo.500.b
		response_text = graygoo.500.b.response
		trigger = {
			NOT = { has_country_flag = gray_warship_active }
		}
		hidden_effect = {
			create_gray_warship = yes
		}
	}
	option = { # Army
		name = graygoo.500.c
		response_text = graygoo.500.c.response
		trigger = {
			NOT = { has_country_flag = gray_army_active }
		}
		hidden_effect = {
			create_gray_army = yes
		}
	}
	option = {
		name = graygoo.500.d
		default_hide_option = yes
	}
}

# Main Menu (Governor)
country_event = {
	id = graygoo.501
	title = "graygoo.500.title"
	desc = "graygoo.501.a.desc"
	desc = "graygoo.501.b.desc"
	desc = "graygoo.501.c.desc"
	desc = "graygoo.501.d.desc"

	diplomatic = yes

	picture_event_data = {
		portrait = event_target:gray_governor
		planet_background = event_target:gray_governor_planet
		room = root
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gray }
		is_same_value = event_target:gray_owner
		has_country_flag = gray_governor_active
		NOT = { has_country_flag = gray_reforming }
		NOT = { has_country_flag = gray_diplomacy_engaged }
		exists = event_target:gray_governor
	}

	immediate = {
		set_country_flag = gray_diplomacy_engaged
		if = {
			limit = {
				any_owned_planet = {
					leader = { is_same_value = event_target:gray_governor }
				}
			}
			random_owned_planet = {
				limit = {
					leader = { is_same_value = event_target:gray_governor }
				}
				save_event_target_as = gray_governor_planet
			}
		}
		else = {
			capital_scope = { save_event_target_as = gray_governor_planet }
		}
	}

	after = {
		hidden_effect = { remove_country_flag = gray_diplomacy_engaged }
	}

	option = { # Warship
		name = graygoo.500.b
		response_text = graygoo.501.b.response
		allow = {
			hidden_trigger = { exists = event_target:gray_governor } # To prevent exploit
		}
		hidden_effect = {
			create_gray_warship = yes
		}
	}
	option = { # Army
		name = graygoo.500.c
		response_text = graygoo.501.c.response
		allow = {
			hidden_trigger = { exists = event_target:gray_governor }
		}
		hidden_effect = {
			create_gray_army = yes
		}
	}
	option = {
		name = graygoo.500.d
		default_hide_option = yes
	}
}

# Main Menu (Warship)
country_event = {
	id = graygoo.502
	title = "graygoo.500.title"
	desc = "graygoo.502.a.desc"
	desc = "graygoo.502.b.desc"
	desc = "graygoo.502.c.desc"
	desc = "graygoo.502.d.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gray }
		is_same_value = event_target:gray_owner
		has_country_flag = gray_warship_active
		NOT = { has_country_flag = gray_reforming }
		NOT = { has_country_flag = gray_diplomacy_engaged }
		exists = event_target:gray_warship
		any_owned_fleet = { is_same_value = event_target:gray_warship }
		event_target:gray_warship = { num_ships > 0 }
	}

	immediate = {
		set_country_flag = gray_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gray_diplomacy_engaged }
	}

	option = { # Governor
		name = graygoo.500.a
		response_text = graygoo.502.a.response
		allow = {
			hidden_trigger = { # To prevent exploit
				event_target:gray_warship = { num_ships > 0 }
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.a
				event_target:gray_warship = { is_in_combat = no }
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.b
				event_target:gray_warship = { NOT = { has_hp_percentage < 1.0 } }
			}
		}
		hidden_effect = {
			create_gray_governor = yes
		}
	}
	option = { # Army
		name = graygoo.500.c
		response_text = graygoo.502.c.response
		allow = {
			hidden_trigger = {
				event_target:gray_warship = { num_ships > 0 }
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.a
				event_target:gray_warship = { is_in_combat = no }
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.b
				event_target:gray_warship = { NOT = { has_hp_percentage < 1.0 } }
			}
		}
		hidden_effect = {
			create_gray_army = yes
		}
	}
	option = {
		name = graygoo.500.d
		default_hide_option = yes
	}
}

# Main Menu (Army)
country_event = {
	id = graygoo.503
	title = "graygoo.500.title"
	desc = "graygoo.503.a.desc"
	desc = "graygoo.503.b.desc"
	desc = "graygoo.503.c.desc"
	desc = "graygoo.503.d.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gray }
		has_country_flag = gray_army_active
		NOT = { has_country_flag = gray_reforming }
		NOT = { has_country_flag = gray_diplomacy_engaged }
		is_same_value = event_target:gray_owner
		any_owned_army = {
			army_type = gray_army
			OR = {
				exists = planet
				AND = {
					exists = fleet
					fleet = { num_ships > 0 }
				}
			}
		}
	}

	immediate = {
		set_country_flag = gray_diplomacy_engaged
	}

	after = {
		hidden_effect = { remove_country_flag = gray_diplomacy_engaged }
	}

	option = { # Governor
		name = graygoo.500.a
		response_text = graygoo.503.a.response
		allow = {
			hidden_trigger = {  # To prevent exploit
				any_owned_army = {
					army_type = gray_army
					OR = {
						exists = planet
						AND = {
							exists = fleet
							fleet = { num_ships > 0 }
						}
					}
				}
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.a
				any_owned_army = {
					army_type = gray_army
					OR = {
						AND = {
							exists = planet planet = { has_ground_combat = no }
						}
						AND = {
							exists = fleet fleet = { is_in_combat = no }
						}
					}
				}
			}
		}
		hidden_effect = {
			create_gray_governor = yes
		}
	}
	option = { # Warship
		name = graygoo.500.b
		response_text = graygoo.503.b.response
		allow = {
			hidden_trigger = {
				any_owned_army = {
					army_type = gray_army
					OR = {
						exists = planet
						AND = {
							exists = fleet
							fleet = { num_ships > 0 }
						}
					}
				}
			}
			custom_tooltip = {
				fail_text = graygoo.500.allow.a
				any_owned_army = {
					army_type = gray_army
					OR = {
						AND = {
							exists = planet planet = { has_ground_combat = no }
						}
						AND = {
							exists = fleet fleet = { is_in_combat = no }
						}
					}
				}
			}
		}
		hidden_effect = {
			create_gray_warship = yes
		}
	}
	option = {
		name = graygoo.500.d
		default_hide_option = yes
	}
}

# Main Menu (Gray Reforming)
country_event = {
	id = graygoo.504
	title = "graygoo.500.title"
	desc = "graygoo.504.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = gray }
		is_same_value = event_target:gray_owner
		has_country_flag = gray_reforming
	}

	option = {
		name = OK
	}
}

# Gray destroyed or disbanded
event = {
	id = graygoo.510
	hide_window = yes

	is_triggered_only = yes

	trigger = {
		any_country = { is_country_type = gray }
		exists = event_target:gray_owner
		event_target:gray_owner = {
			OR = {
				AND = {
					has_country_flag = gray_army_active
					NOT = {
						any_owned_army = { army_type = gray_army }
					}
				}
				AND = {
					has_country_flag = gray_warship_active
					NOT = { exists = event_target:gray_warship }
				}
				AND = {
					has_country_flag = gray_governor_active
					NOT = { exists = event_target:gray_governor }
				}
			}
		}
	}

	immediate = {
		event_target:gray_owner = {
			remove_country_flag = gray_governor_active
			remove_country_flag = gray_warship_active
			remove_country_flag = gray_army_active
			set_country_flag = gray_reforming
			add_modifier = {
				modifier = "gray_scattered"
				days = 3600
			}
			country_event = { id = graygoo.511 }
			country_event = { id = graygoo.512 days = 3600 }
		}
	}
}

# Gray regenerating
country_event = {
	id = graygoo.511
	title = "graygoo.511.name"
	desc = "graygoo.511.desc"
	picture = GFX_evt_circuitry_modification
	show_sound = event_radio_chatter

	is_triggered_only = yes

	option = {
		name = graygoo.511.a
	}
}

# Gray returns
country_event = {
	id = graygoo.512
	title = "graygoo.500.title"
	desc = "graygoo.512.a.desc"
	desc = "graygoo.512.b.desc"
	desc = "graygoo.512.c.desc"

	diplomatic = yes

	picture_event_data = {
		room = no_video_feed_room
	}

	is_triggered_only = yes

	immediate = {
		remove_country_flag = gray_reforming
	}

	option = {
		name = graygoo.512.a
	}
}

# Entering "Empty" L-Cluster
ship_event = {
	id = graygoo.550
	title = "graygoo.550.name"
	desc = "graygoo.550.desc"
	picture = GFX_evt_ruined_system
	show_sound = event_radio_chatter

	is_triggered_only = yes

	trigger = {
		NOR = {
			# has_global_flag = gray_goo_crisis_set
			# has_global_flag = dragon_season
			has_global_flag = gray_goo_empire_set
		}
		from = { has_star_flag = lcluster1 }
	}

	option = {
		name = graygoo.550.a
	}
}
