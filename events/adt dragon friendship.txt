namespace = distar

# goo_dragon_friendship
country_event = {
	id = distar.13006
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = { NOT = { exists = event_target:spawning_dragons } }
			every_country = {
				if = {
					limit = { is_country_type = ldragon_country }
					save_global_event_target_as = spawning_dragons
				}
				else = { break = yes }
			}
		}
		event_target:spawning_dragons = {
			random_country = {
				limit = {
					OR = {
						is_country_type = gray_goo
						is_country_type = gate_builders
					}
				}
				set_faction_hostility = {
					set_hostile = no
					#set_neutral = no
					set_friendly = yes
					target = prev # Dragons
				}
				prev = {
					set_faction_hostility = {
						set_hostile = no
						#set_neutral = no
						set_friendly = yes
						target = prev # Gray Tempest
					}
				}

			}
		}
	}
}

country_event = {
	id = distar.10950
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_country_flag = lcluster_opener
		set_global_flag = l_cluster_opened
		# outcome, to be determined at game start
		if = {
			limit = { has_global_flag = dragon_season }
			country_event = { id = distar.13000 }
			country_event = { id = distar.13006 days = 51 }
		}
		# spawn L-Cluster
		country_event = { id = distar.10951 }
		# we don't need this anymore as we always open all gates immediately
		# # enable other L-Gates over time
		# random_country = {
		# 	limit = { is_country_type = global_event }
		# 	country_event = { id = distar.10960 days = 200 random = 500 }
		# }
		if = {
			limit = { has_global_flag = gray_goo_crisis_set }
			country_event = { id = graygoo.1 days = 50 }
			#  double call?
			every_megastructure = {
				limit = {
					is_megastructure_type = lgate_base
					NOT = { has_megastructure_flag = lgate_activated }
				}
				activate_lgate = yes
			}
		}
		else_if = {
			limit = { has_global_flag = gray_goo_empire_set }
			country_event = { id = graygoo.100 days = 7 }
		}

		# enable L-Gate
		from.solar_system = {
			if = {
				# flag prevents the Tempest from using this gate,
				# do not set the flag if there's only one l-gate system
				limit = {
					any_system = {
						has_star_flag = lgate
						NOT = { is_same_value = prev }
					}
				}
				set_star_flag = lgate_originating_system
			}
			else = {
				root = { set_country_flag = only_one_lgate }
			}
			random_system_megastructure = {
				limit = {
					is_megastructure_type = lgate_base
					NOT = { has_megastructure_flag = lgate_activated }
				}
				activate_lgate = yes
			}
		}
		# activated terminal egress l-gate
		event_target:lcluster1 = {
			random_system_megastructure = {
				activate_gateway = this
				set_megastructure_flag = lgate_activated
			}
		}
		set_global_flag = lgates_activated_globally
		every_playable_country = {
			if = {
				limit = { is_researching_technology = tech_lgate_activation }
				give_technology = {
					tech = tech_lgate_activation
					message = no
				}
			}
		}
	}
}
